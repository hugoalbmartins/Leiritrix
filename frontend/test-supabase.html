<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teste de Conex√£o Supabase</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #0a0a0a;
      color: #ffffff;
    }
    .card {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .status {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success { background: #064e3b; border: 1px solid #10b981; }
    .error { background: #7f1d1d; border: 1px solid #ef4444; }
    .warning { background: #78350f; border: 1px solid #f59e0b; }
    .info { background: #1e3a8a; border: 1px solid #3b82f6; }
    button {
      background: #c8f31d;
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
    }
    button:hover { background: #d4ff00; }
    pre {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border: 1px solid #333;
    }
    input {
      width: 100%;
      padding: 10px;
      background: #0a0a0a;
      border: 1px solid #333;
      color: white;
      border-radius: 4px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>üîç Teste de Conex√£o Supabase</h1>

  <div class="card">
    <h2>1. Verifica√ß√£o de Vari√°veis de Ambiente</h2>
    <div id="env-check"></div>
  </div>

  <div class="card">
    <h2>2. Teste de Conex√£o</h2>
    <button onclick="testConnection()">Testar Conex√£o</button>
    <div id="connection-result"></div>
  </div>

  <div class="card">
    <h2>3. Teste de Login</h2>
    <input type="email" id="email" placeholder="Email" value="admin@leiritrix.com">
    <input type="password" id="password" placeholder="Password" value="Admin123!@#">
    <button onclick="testLogin()">Testar Login</button>
    <div id="login-result"></div>
  </div>

  <div class="card">
    <h2>4. Informa√ß√µes de Debug</h2>
    <div id="debug-info"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://kzvzjrgmqneqygwfihzw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt6dnpqcmdtcW5lcXlnd2ZpaHp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNTQ5NjAsImV4cCI6MjA4MjkzMDk2MH0.jTpjTMRtI1mM9eNrKTnLXeVKWEtkUFji_h7HAJyp4HI';

    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function checkEnvVariables() {
      const envCheck = document.getElementById('env-check');
      let html = '';

      if (SUPABASE_URL) {
        html += `<div class="status success">‚úÖ VITE_SUPABASE_URL: ${SUPABASE_URL}</div>`;
      } else {
        html += `<div class="status error">‚ùå VITE_SUPABASE_URL: N√ÉO CONFIGURADA</div>`;
      }

      if (SUPABASE_ANON_KEY) {
        html += `<div class="status success">‚úÖ VITE_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY.substring(0, 20)}...</div>`;
      } else {
        html += `<div class="status error">‚ùå VITE_SUPABASE_ANON_KEY: N√ÉO CONFIGURADA</div>`;
      }

      envCheck.innerHTML = html;
    }

    window.testConnection = async function() {
      const resultDiv = document.getElementById('connection-result');
      resultDiv.innerHTML = '<div class="status info">‚è≥ Testando conex√£o...</div>';

      try {
        const { data, error } = await window.supabase.from('users').select('count', { count: 'exact', head: true });

        if (error) {
          resultDiv.innerHTML = `
            <div class="status error">
              ‚ùå Erro de Conex√£o<br>
              <strong>Mensagem:</strong> ${error.message}<br>
              <strong>C√≥digo:</strong> ${error.code || 'N/A'}<br>
              <strong>Detalhes:</strong> ${error.details || 'N/A'}
            </div>
            <pre>${JSON.stringify(error, null, 2)}</pre>
          `;
          return;
        }

        resultDiv.innerHTML = `
          <div class="status success">
            ‚úÖ Conex√£o bem-sucedida!<br>
            A liga√ß√£o ao Supabase est√° a funcionar corretamente.
          </div>
        `;
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="status error">
            ‚ùå Erro ao conectar<br>
            ${err.message}
          </div>
          <pre>${JSON.stringify(err, null, 2)}</pre>
        `;
      }
    };

    window.testLogin = async function() {
      const resultDiv = document.getElementById('login-result');
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      resultDiv.innerHTML = '<div class="status info">‚è≥ Testando login...</div>';

      try {
        const { data, error } = await window.supabase.auth.signInWithPassword({
          email,
          password
        });

        if (error) {
          let errorHtml = `
            <div class="status error">
              ‚ùå Erro no Login<br>
              <strong>Mensagem:</strong> ${error.message}<br>
              <strong>Status:</strong> ${error.status || 'N/A'}
          `;

          if (error.message.includes('Invalid API key')) {
            errorHtml += `<br><br><strong>‚ö†Ô∏è SOLU√á√ÉO:</strong> Este erro indica que o URL do Vercel n√£o est√° autorizado no Supabase.<br>
            V√° a: Supabase Dashboard ‚Üí Authentication ‚Üí URL Configuration<br>
            E adicione o URL do seu site Vercel.`;
          }

          errorHtml += `</div><pre>${JSON.stringify(error, null, 2)}</pre>`;
          resultDiv.innerHTML = errorHtml;
          return;
        }

        resultDiv.innerHTML = `
          <div class="status success">
            ‚úÖ Login bem-sucedido!<br>
            <strong>Utilizador:</strong> ${data.user.email}<br>
            <strong>ID:</strong> ${data.user.id}<br>
            <strong>Criado em:</strong> ${new Date(data.user.created_at).toLocaleString('pt-PT')}
          </div>
          <pre>${JSON.stringify(data.user, null, 2)}</pre>
        `;

        await window.supabase.auth.signOut();
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="status error">
            ‚ùå Erro ao fazer login<br>
            ${err.message}
          </div>
          <pre>${JSON.stringify(err, null, 2)}</pre>
        `;
      }
    };

    function showDebugInfo() {
      const debugDiv = document.getElementById('debug-info');
      const info = {
        'URL Atual': window.location.href,
        'User Agent': navigator.userAgent,
        'Timestamp': new Date().toISOString(),
        'Protocolo': window.location.protocol,
        'Host': window.location.host
      };

      let html = '<pre>' + JSON.stringify(info, null, 2) + '</pre>';
      debugDiv.innerHTML = html;
    }

    checkEnvVariables();
    showDebugInfo();
  </script>
</body>
</html>
